---
import { Icon } from 'astro-icon/components'
import type { MarkdownHeading } from 'astro';
import { SITE, TRANSLATIONS } from 'src/constants';

type Props = {
  headings: MarkdownHeading[] | null;
};

const { 
  headings = null
} = Astro.props;

const title = TRANSLATIONS[SITE.defaultLanguage].toc;

const filtersHeadings = headings
  ? headings.filter((item) => item.depth === 2 || item.depth === 3)
  : [];

const filtersHeadingsLength = filtersHeadings.length;
---

<div
  id="toc"
  class="hidden lg:block space-y-4 bg-white shadow-black shadow-xs px-4 py-5 border-2 border-black rounded-md h-full lg:h-auto"
>
  <p class="flex items-center gap-1 font-semibold"><Icon name="tabler:list" class="size-4" />{ title }</p>

  <ul class="flex flex-col ml-1 max-w-full">
    {
      filtersHeadings.map((item, index) => (
        <li class="flex items-stretch">
          { Array.from({ length: item.depth - 1 }).map((_v, _i) => (
            <div class="flex flex-col">
              <div
                class:list={[
                  _i === 0 ? 'border-l' : '',
                  'border-skin-dodge border-box border-b border-slate-300',
                ]}
              />
              { index === filtersHeadingsLength - 1 ? (
                ''
              ) : (
                <div
                  class:list={[
                    _i === 0 ? 'border-l' : '',
                    'border-skin-dodge border-box border-slate-300',
                  ]}
                />
              )}
            </div>
          )) }

          <a
            title={ item.slug }
            href={`#${item.slug}`}
            class="inline-block pl-2 truncate"
          >
            { item.text }
          </a>
        </li>
      ))
    }
  </ul>

  <style lang="scss">
    .toc_container {
      overflow-y: scroll;
      /* webkit */
      /* firefox */
      scrollbar-width: none;
      /* ie */
      -ms-overflow-style: none;
      &::-webkit-scrollbar {
        width: 0;
        height: 0;
      }
    }

    .active-heading {
      color: theme('colors.orange.DEFAULT');
      font-weight: 600;
    }
    .border-box {
      height: 13px;
      width: 12px;
    }
  </style>

  <script>
    const anchors = document.querySelectorAll('h2, h3');
    const links = document.querySelectorAll('#toc > ul > li > a');

    const observerOptions = {
      root: null,
      rootMargin: '0px  0px -75% 0px',
      threshold: 0,
    };

    const callback = (entries: IntersectionObserverEntry[]) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          let index = Array.from(anchors).indexOf(entry.target);

          links.forEach((link) => {
            link.classList.remove('active-heading');
          });
          links[index].classList.add('active-heading');
        }
      });
    };

    const observer = new IntersectionObserver(callback, observerOptions);
    anchors.forEach((link) => {
      observer.observe(link);
    });
  </script>
</div>
