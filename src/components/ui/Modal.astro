---
interface Props {
  id: string;
  open?: boolean;
  closeOnOverlay?: boolean;
  closeOnEsc?: boolean;
  widthClass?: string;
}

const {
  id,
  open = false,
  closeOnOverlay = true,
  closeOnEsc = true,
  widthClass = 'max-w-md',
} = Astro.props;

const dialogId = `${id}-dialog`;
const titleId = `${id}-title`;

---
<div id={ id }
     class={`modal fixed inset-0 z-50 ${ open ? '' : 'hidden' }`}
     aria-hidden={ open ? 'false' : 'true' } data-closeOnOverlay={ closeOnOverlay } data-closeOnEsc={ closeOnEsc }>

  <!-- overlay -->
  <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"
       data-overlay
       role="presentation"></div>

  <!-- dialog -->
  <div class="absolute inset-0 place-items-center grid p-4">
    <div id={ dialogId }
         role="dialog"
         aria-modal="true"
         aria-labelledby={ titleId }
         class={`w-full ${widthClass} rounded-2xl bg-white text-slate-900 shadow-2xl ring-1 ring-black/5`}>
      <!-- header -->
      <div class="flex justify-between items-center px-5 pt-4">
        <p id={ titleId } class="font-bold text-2xl">
          <slot name="title" />
        </p>
        <button type="button"
                class="inline-flex justify-center items-center hover:bg-slate-100 p-2 rounded-md text-slate-500 hover:text-slate-700"
                aria-label="Close"
                data-close>
          âœ•
        </button>
      </div>

      <!-- body -->
      <div class="px-5 py-4">
        <slot />
      </div>

      <!-- actions -->
      <div class="flex items-center gap-2 px-5 pb-5">
        <slot name="actions" />
      </div>
    </div>
  </div>

  <script>
    (() => {
      const root = document.querySelector('.modal') as HTMLElement;
      if (!root) return;
      const id = root.dataset.id;
      const closeOnOverlay = root.dataset.closeOnOverlay;
      const closeOnEsc = root.dataset.closeOnEsc;
      const closeBtns = root.querySelectorAll('[data-close]');
      const overlay = root.querySelector('[data-overlay]');

      function open() {
        root.classList.remove('is-hidden');
        root.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
      }
      function close() {
        root.classList.add('is-hidden');
        root.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
      }

      window.ModalApi = window.ModalApi || {};
      window.ModalApi[{ id }] = { open, close };

      closeBtns.forEach(b => b.addEventListener('click', close));

      if (closeOnOverlay) {
        overlay?.addEventListener('click', (e) => {
          if (e.target === overlay) close();
        });
      }

      if (closeOnEsc) {
        root.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            e.stopPropagation();
            close();
          }
        });
      }
    })();
  </script>
</div>
