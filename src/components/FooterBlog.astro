---
import { Icon } from 'astro-icon/components';
import { useI18n } from '@utils/translate';
import { SITE, TRANSLATIONS, type LangCode } from 'src/constants';
import type { Footer } from 'src/types';
import Article from './Article.astro';
import MdContent from './MdContent.astro';
import config from '../content/site-config.json';

interface Props {
  lang?: LangCode;
}

const { 
  lang = SITE.defaultLanguage
 } = Astro.props;

const t = useI18n(lang);
const translation = TRANSLATIONS[lang];
const today = new Date();
const footer = config.footer as Footer;
---
<footer class="mt-8 page-footer">
  <div class="container">
    <div class="flex flex-wrap lg:flex-nowrap gap-2 lg:gap-8 bg-white shadow-black shadow-xs px-4 py-5 border-2 border-black rounded-md">
      <div class="space-y-4 basis-full lg:basis-7/12">
        <a class="block max-w-48 brand" href={ Astro.url.origin }>
          <img src={ footer.logo } alt={ t(SITE.title) } />
        </a>
        <div class="space-y-2">
          <p class="font-bold text-base">{ translation.aboutUs }:</p>

          <Article class="opacity-70 text-sm">
            <MdContent content={ t(footer.about) } />
          </Article>

          <p class="font-bold text-base">{ translation.contacts }:</p>

          <ul class="list-none">
            { footer.contacts && footer.contacts.map((link) => (
              <li class="inline-flex items-center gap-1 hover:border-b text-nowrap"> 
                <Icon name={ link.icon } class="size-3" />
                <a class="text-sm" href={ t(link.href) } title={ t(link.label) }>{ t(link.label) }</a>
              </li>
            )) }
          </ul>
        </div>
      </div>
      <div class="basis-full lg:basis-5/12">
        <form class="space-y-2 contact-form" action="/api/sendMail">
          <p class="font-bold text-base">{ translation.writeUs }:</p>
          <input
            id="name"
            name="name"
            type="text"
            required
            class="block px-3 py-2 border border-gray focus:border-orange-200 rounded-md focus:ring-orange-200 w-full text-sm"
            placeholder="Your name"
            maxlength="30"
          />
          <input
            id="email"
            name="email"
            type="email"
            required
            class="block px-3 py-2 border border-gray focus:border-orange-200 rounded-md focus:ring-orange-200 w-full text-sm"
            placeholder="you@example.com"
            maxlength="50"
          />
          <textarea
            id="message"
            name="message"
            rows="4"
            required
            class="block px-3 py-2 border border-gray focus:border-orange-200 rounded-md focus:ring-orange-200 w-full min-h-10 text-sm"
            placeholder="Your message"
            maxlength="500"
          ></textarea>

          <button
            type="submit"
            class="group inline-flex items-center bg-orange hover:bg-orange-200 px-4 py-2 rounded-md focus:outline-none font-medium text-white text-sm"
          >
            <svg class="hidden group-[.is-sending]:inline-block mr-3 -ml-1 size-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            { translation.send } 
          </button>
          <p class="text-slate-500 text-sm" data-contact-status></p>
        </form>
        <script is:inline>
           document.addEventListener('DOMContentLoaded', () => {
            const form = document.querySelector('.contact-form');
            if (!form) return;

            const statusEl = form.querySelector('[data-contact-status]');
            const submitBtn = form.querySelector('button[type="submit"]');
            if (!statusEl || !submitBtn) return;

            let isSubmitting = false;

            form.addEventListener('submit', async (event) => {
              event.preventDefault();
              if (isSubmitting) return;
              isSubmitting = true;

              submitBtn.disabled = true;
              submitBtn.classList.add('is-sending');

              try {
                const formData = new FormData(form);

                const res = await fetch(form.action, {
                  method: 'POST',
                  body: formData,
                  headers: {
                    Accept: 'application/json',
                  },
                });

                let data = null;
                try {
                  data = await res.json();
                } catch {
                  // ignore json parse error, we'll handle by res.ok
                }

                if (!res.ok || !data?.ok) {
                  const msg = data?.error || 'Something went wrong. Please try again.';
                  throw new Error(msg);
                }

                // success
                form.reset();
                statusEl.textContent = 'Message sent. Thank you!'; // translation.success
              } catch (err) {
                console.error(err);
                statusEl.textContent =
                  err?.message && err.message !== 'Failed to fetch'
                    ? err.message
                    : 'Something went wrong. Please try again later.'; // translation.error
              } finally {
                isSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.classList.remove('is-sending');
              }
            });
          });
        </script>
      </div>
    </div>
    <div class="flex flex-wrap md:flex-nowrap justify-center md:justify-between items-center gap-2 md:my-4 mt-4 mb-20">
      <p class="order-2 md:order-1 text-slate-500 text-xs">&copy; { today.getFullYear() } { SITE.author } â€” { translation.copyright }</p>
      <ul class="flex order-1 md:order-2 divide-x divide-slate-300 list-none divide">
        { footer.navigation && footer.navigation.map((link) => (
          <li class="px-0.5 text-nowrap leading-none"> 
            <a class="mx-1 text-slate-500 text-xs" href={ t(link.href) } title={ t(link.label) }>{ t(link.label) }</a>
          </li>
        )) }
      </ul>
    </div>
  </div>
</footer>