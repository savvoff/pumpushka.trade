---
import { getCollection, getEntry } from 'astro:content';
import DocsLayout from '@layouts/Docs.astro';
import { buildDocsSidebar, pathToSlug } from '@utils/buildDocsSidebar';
import { SITE } from 'src/constants';

export const prerender = true;

export async function getStaticPaths() {
  const docs = await getCollection(
    'docs',
    ({ data }) => !data.draft && (data.lang ?? SITE.defaultLanguage) === SITE.defaultLanguage
  );

  return docs.map((entry) => {
    const base = pathToSlug(entry.id, SITE.defaultLanguage);
    return {
      params: { slug: base },
      props: { slug: entry.slug }
    };
  });
}

const { slug } = Astro.props;
const { slug: slugReal } = Astro.params;

const entry = await getEntry('docs', slug);

if (!entry) {
  return Astro.redirect('/404', 302);
}

const rendered = await entry.render();
const { Content, headings } = rendered;

const frontmatter = entry.data;
const title = frontmatter.title;
const description = frontmatter.description;
const lang = SITE.defaultLanguage;

const sidebar = await buildDocsSidebar(lang, { withLangPrefix: false });
const content = { ...frontmatter, slug: slugReal };
---

<DocsLayout
  title={ `${title} | ${SITE.author}` } 
  description={ description} 
  lang={ lang }
  content={ content }
  headings={ headings }
  sidebar={ sidebar }
>
  <Content />
</DocsLayout>
